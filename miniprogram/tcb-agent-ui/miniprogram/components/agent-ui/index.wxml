<!-- agent ui ç»„ä»¶æ ¹å®¹å™¨ -->
<view class="agent-ui">
  <view class="navBar" wx:if="{{chatMode === 'bot'}}">
    <view class="nav-content">
      <!-- <image src="{{bot.avatar}}" mode="aspectFill" class="bot-avatar"/> -->
      <text class="bot-name">{{bot.name}}</text>
    </view>
  </view>
  <!-- èŠå¤©å¯¹è¯åŒº -->
  <scroll-view bindwheel="onWheel" enhanced="{{true}}" bindscroll="onScroll" binddragstart="handleScrollStart" class="main" style="height: {{windowInfo.windowHeight-footerHeight-(chatMode === 'bot' ? 40 : 0)}}px;" scroll-y="{{true}}" scroll-top="{{viewTop}}" scroll-into-view="{{ scrollTo }}" lower-threshold="1" bindscrolltolower="handleScrollToLower" show-scrollbar="{{false}}" refresher-enabled="{{true}}" refresher-threshold="{{80}}" bindrefresherrefresh="handelRefresh" refresher-triggered="{{triggered}}" bounces="{{false}}">
    <view wx:if="{{chatMode === 'bot'}}" class="tips">
      {{refreshText}}
    </view>
    <view wx:if="{{chatMode === 'model'}}" class="nav">
      <image src="{{bot.avatar||modelConfig.logo}}" mode="aspectFill" class="avatar" />
      <view style="line-height: 47px; font-size: 20px; font-weight: 500;">{{chatMode==='bot'?bot.name:modelConfig.modelProvider}}</view>
      <view style="line-height: 26px;padding: 0px 16px; font-size: 32rpx;">{{chatMode==='bot'?"":modelConfig.welcomeMsg}}</view>
    </view>
    <block wx:for="{{chatRecords}}" wx:key="record_id">
      <!-- ç³»ç»ŸèŠå¤© -->
      <view class="system" style="padding-left: {{showBotAvatar?80:0}}rpx;" wx:if="{{item.role==='assistant'}}">
        <view class="avatar-left" wx:if="{{showBotAvatar}}">
          <image src="{{chatMode==='bot'?bot.avatar:modelConfig.logo}}" mode="aspectFill" style="width: 56rpx;height: 56rpx; border-radius: 28rpx;" />
        </view>
        <view>
          <!-- æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”æ˜¯å‘é€çŠ¶æ€æ˜¾ç¤ºå‘é€ä¸­ -->
          <block wx:if="{{(chatRecords.length-1)===index&&chatStatus===1}}">
            <view style="display: flex;align-items: center; gap: 4px; font-size: 32rpx;line-height: 1.8;">
              <image src="./imgs/loading.svg" mode="aspectFill" style="width: 14px;height: 14px;" /> è¯·ç¨ç­‰ï¼Œæ­£åœ¨å–åŠ›æ€è€ƒä¸­ ğŸ¤”
            </view>
          </block>
          <block wx:else>
            <!-- è”ç½‘æœç´¢ -->
            <FoldedCard wx:if="{{item.search_info}}" initStatus="{{false}}" showBgColor="{{true}}">
              <view slot="title" style="opacity: 0.7;font-size: 14px;display: flex; align-items: center; gap: 8px;">
                <image src="./imgs/search.svg" mode="aspectFill" style="width: 36rpx;height: 36rpx;" />
                <text>å·²å‚è€ƒ {{item.search_info.search_results.length}} ä¸ªç½‘é¡µ</text>
              </view>
              <view slot="content" class="link-box">
                <block wx:for="{{item.search_info.search_results}}" wx:key="index">
                  <view bind:tap="copyUrl" data-url="{{item.url}}" style="margin-bottom: 3px; font-size: 14px;color: rgb(0, 82, 217); line-height: 24px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"> {{index+1}}.{{item.title}}</view>
                </block>
              </view>
            </FoldedCard>
            <!-- çŸ¥è¯†åº“ -->
            <view wx:if="{{item.knowledge_base&&item.knowledge_base.length}}" style="border-radius: 8px;margin-bottom: 12px;background-color: #f5f5f5;padding: 18rpx 26rpx;display: inline-block;opacity: 0.7;font-size: 14px;">
              å·²å‚è€ƒ {{item.knowledge_base.length}} ä¸ªçŸ¥è¯†åº“
            </view>
            <!-- æ¨ç†è¿‡ç¨‹ -->
            <FoldedCard wx:if="{{!!item.reasoning_content}}" initStatus="{{true}}" showBgColor="{{false}}">
              <view slot="title" style="opacity: 0.7;font-size: 14px; display: flex; align-items: center; gap: 8px;">
                <image src="./imgs/system-sum.svg" mode="aspectFill" style="width: 36rpx;height: 36rpx;" />
                <block wx:if="{{item.pauseThinking}}">
                  å·²åœæ­¢æ€è€ƒ
                </block>
                <block wx:else>
                  <text>{{item.reasoning_content&&!item.content?"æ€è€ƒä¸­...":"å·²æ·±åº¦æ€è€ƒï¼ˆç”¨æ—¶"+item.thinkingTime+"ç§’ï¼‰"}}</text>
                </block>
              </view>
              <view style="padding-left: 25rpx;margin-top: 28rpx; border-left: rgb(165, 164, 164) solid 2px; opacity: 0.7;" slot="content">
                <markdownPreview markdown="{{item.reasoning_content||''}}" fontSize="{{28}}"></markdownPreview>
              </view>
            </FoldedCard>
            <markdownPreview markdown="{{item.content||''}}"></markdownPreview>
            <!-- ä¸‹é¢çš„æŒ‰é’® -->
            <view style="display: flex; gap: 10px;justify-content: flex;" wx:if="{{!item.hiddenBtnGround}}">
              <image mode="widthFix" bind:tap="copyChatRecord" src='./imgs/copy.svg' style="width: 36rpx; height: 36rpx;" data-content="{{item.content}}" />
              <button class="share_btn" open-type="share">
                <image mode="widthFix" src='./imgs/share.svg' style="width: 36rpx; height: 36rpx;vertical-align: top;" bind:tap="share" />
              </button>
              <block wx:if="{{chatMode=== 'bot'}}">
                <image mode="widthFix" bind:tap="openFeedback" data-feedbackType="upvote" data-feedbackRecordId="{{item.record_id}}" src='./imgs/thumb-up.svg' style="width: 36rpx; height: 36rpx;" />
                <image mode="widthFix" bind:tap="openFeedback" data-feedbackType="downvote" data-feedbackRecordId="{{item.record_id}}" src='./imgs/thumb-down.svg' style="width: 36rpx; height: 36rpx;" />
              </block>
            </view>
          </block>
        </view>
      </view>
      <!-- ç”¨æˆ·è¾“å…¥ -->
      <view class="userContent" wx:if="{{item.role==='user'}}">
        <view class="user" style="padding-left: {{showBotAvatar?80:0}}rpx;">
          <view class="user_content">
            {{item.content}}
          </view>
        </view>
        <view class="fileBar">
          <chatFile enableDel="{{false}}" wx:for="{{item.fileList}}" wx:for-item="innerItem" wx:key="tempPath" fileData="{{innerItem}}" bind:removeChild="handleRemoveChild" bind:changeChild="handleChangeChild"></chatFile>
        </view>
      </view>
    </block>
    <!-- æ¨èé—®é¢˜ -->
    <block wx:for="{{questions}}" wx:key="item">
      <view class="questions" style="padding-left: {{showBotAvatar?80:0}}rpx;">
        <view class="question_content" bind:tap="handleSendMessage" data-message="{{item}}">{{item}}</view>
      </view>
    </block>
    <view id="scroll-bottom" style="width: 100%;height: 20px;"></view>
  </scroll-view>
  <!-- åº•éƒ¨è¾“å…¥åŒº -->
  <view class="footer">
    <view class="feature_list" wx:if="{{showFeatureList}}">
      <view bind:tap="handleClickWebSearch" class="{{'webSearchSwitch ' + (useWebSearch ? 'feature_enable' : '')}}">
        <image src="{{ useWebSearch ? './imgs/internetUse.svg' : './imgs/internet.svg'}}" mode="" style="width: 40rpx;height:30px;margin-right: 10rpx" />
        <text>è”ç½‘æœç´¢</text>
      </view>
    </view>
    <view class="file_list" wx:if="{{showFileList}}">
      <chatFile enableDel="{{true}}" wx:for="{{sendFileList}}" wx:key="tempId" fileData="{{item}}" bind:removeChild="handleRemoveChild" bind:changeChild="handleChangeChild"></chatFile>
    </view>
    <view class="foot-function">
      <scroll-view class="img-box" scroll-x="true" wx:if="{{!!imageList.length}}">
        <block wx:for="{{imageList}}" wx:key="tempFilePath">
          <view class="img-preview">
            <image src="{{item.tempFilePath}}" alt="" model='aspectFill' class="img-preview-image" />
            <!-- è’™å±‚ -->
            <view class="img-preview-loading" wx:if="{{!!!item.base64Url}}"></view>
            <!-- åˆ é™¤æŒ‰é’® -->
            <image src="./imgs/close.svg" mode="aspectFill" class="img-preview-close" bind:tap="deleteImg" data-index="{{index}}" />
          </view>
        </block>
      </scroll-view>

      <view class="input_box">
        <input class="input" value="{{inputValue}}" type="text" maxlength="1024" bindfocus="bindInputFocus" bindinput="bindKeyInput" placeholder="è¯´ç‚¹ä»€ä¹ˆå§" bindconfirm="handleSendMessage" confirm-type="send" adjust-position cursor-spacing="20" />
        <!-- åŠ å· -->
        <image src="./imgs/set.svg" class="set" mode="widthFix" bind:tap="handleClickTools" />
        <!-- å‘é€æŒ‰é’® -->
        <image src="./imgs/send.svg" class="set" mode="widthFix" wx:if="{{!!inputValue&&chatStatus===0}}" bind:tap="handleSendMessage" style="transform: rotate(-40deg);transform-origin: 8px 8px" />
        <!-- æš‚åœæŒ‰é’® -->
        <image src="./imgs/stop.svg" class="set" mode="widthFix" wx:if="{{!(chatStatus===0)}}" bind:tap="stop" />
      </view>
    </view>
    <!-- åº•éƒ¨å·¥å…·æ  -->
    <view class="tool_box" wx:if="{{showTools}}">
      <view class="function" bind:tap="clearChatRecords">
        <image src="./imgs/clear.svg" alt="widthFix" class="icon" />
        <text class="text_desc">æ¸…é™¤</text>
      </view>
      <view wx:if="{{showUploadImg && chatMode === 'bot'}}" class="function" bind:tap="handleAlbum">
        <image src="./imgs/uploadImg.svg" alt="widthFix" class="icon" />
        <text class="text_desc">å›¾ç‰‡</text>
      </view>
      <view wx:if="{{showUploadFile && chatMode === 'bot'}}" class="function" bind:tap="handleUploadMessageFile">
        <image src="./imgs/wechat.svg" alt="widthFix" class="icon" />
        <text class="text_desc">å¾®ä¿¡æ–‡ä»¶</text>
      </view>
      <view wx:if="{{showUploadImg && chatMode === 'bot'}}" class="function" bind:tap="handleCamera">
        <image src="./imgs/camera.svg" alt="widthFix" class="icon" />
        <text class="text_desc">ç›¸æœº</text>
      </view>
    </view>
  </view>
  <image bind:tap="autoToBottom" wx:if="{{manualScroll}}" style="width:35px;height:35px;border-radius: 50px;position: absolute;bottom:150px;right: 20px;padding: 5px;background-color: white;" src="./imgs/toBottom.svg" mode="aspectFit" binderror="" bindload="" />
  <feedback input="{{input}}" aiAnswer="{{aiAnswer}}" isShowFeedback="{{isShowFeedback}}" bind:close="closefeedback" feedbackRecordId="{{feedbackRecordId}}" feedbackType="{{feedbackType}}" botId="{{bot.botId}}"></feedback>
</view>